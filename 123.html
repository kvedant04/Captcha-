<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Verification</title>
    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo */
            --primary-hover: #4338ca;
            --success-color: #10b981;
            --error-color: #ef4444;
            --surface-color: rgba(255, 255, 255, 0.85); /* Glassy */
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: rgba(255, 255, 255, 0.6);
            --radius: 16px;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --shadow-card: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
            user-select: none;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: var(--font-family);
            background-color: #0f172a;
            overflow: hidden; /* For background anims */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-primary);
            perspective: 1000px;
        }

        /* --- Living Background --- */
        .bg-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            opacity: 0.6;
            animation: float 10s infinite ease-in-out alternate;
        }
        .orb-1 { width: 500px; height: 500px; background: #4f46e5; top: -100px; left: -100px; animation-duration: 12s; }
        .orb-2 { width: 400px; height: 400px; background: #ec4899; bottom: -50px; right: -50px; animation-duration: 9s; animation-delay: -2s; }
        .orb-3 { width: 300px; height: 300px; background: #06b6d4; top: 40%; left: 40%; animation-duration: 15s; animation-delay: -5s; }

        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, 40px) scale(1.1); }
        }

        /* --- Glass Container --- */
        .captcha-container {
            width: 520px;
            background: var(--surface-color);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.4);
            border-radius: var(--radius);
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.1), 
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                inset 0 0 20px rgba(255,255,255,0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 580px;
            transform-style: preserve-3d;
            animation: containerPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes containerPop {
            0% { opacity: 0; transform: scale(0.9) translateY(20px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* --- Header --- */
        .header {
            padding: 24px 32px;
            background: rgba(255,255,255,0.5);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #111827 0%, #4f46e5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .shield-icon {
            width: 28px;
            height: 28px;
            fill: url(#shield-gradient); 
            filter: drop-shadow(0 2px 4px rgba(79, 70, 229, 0.3));
        }

        .back-link {
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            background: rgba(255,255,255,0.5);
            border: 1px solid rgba(0,0,0,0.05);
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            transition: all 0.2s;
        }
        .back-link:hover {
            background: white;
            color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* -- Content Area --- */
        .content {
            padding: 32px;
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* --- Views --- */
        .view-section {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100%;
            animation: slideIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        .view-section.active { display: flex; }

        /* --- Menu Grid --- */
        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 24px;
        }

        .menu-card {
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.6);
            border-radius: 12px;
            background: linear-gradient(145deg, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.3) 100%);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 14px;
            position: relative;
            overflow: hidden;
        }

        .menu-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.8), transparent);
            transform: translateX(-100%);
            transition: 0.5s;
        }

        .menu-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.15);
            border-color: rgba(79, 70, 229, 0.3);
        }
        
        .menu-card:hover::before { transform: translateX(100%); }

        .menu-card svg {
            width: 40px;
            height: 40px;
            fill: #6b7280;
            transition: all 0.3s;
        }
        
        .menu-card:hover svg {
            fill: var(--primary-color);
            transform: scale(1.1) rotate(5deg);
        }

        .menu-card span {
            font-size: 15px;
            font-weight: 600;
        }

        /* --- Controls --- */
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .module-title { font-size: 18px; font-weight: 700; color: #374151; }

        .control-row { display: flex; gap: 12px; margin-top: 24px; }

        .input-field {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid rgba(209, 213, 219, 0.5);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.2s;
            background: rgba(255,255,255,0.8);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }

        .input-field:focus {
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .btn {
            height: 52px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            letter-spacing: 0.3px;
            transition: all 0.3s;
            padding: 0 32px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
            color: white;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.25);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px rgba(79, 70, 229, 0.35);
        }

        .btn-primary:active { transform: translateY(0); }

        .refresh-btn {
            background: white;
            border: 1px solid rgba(0,0,0,0.1);
            cursor: pointer;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .refresh-btn:hover {
            transform: rotate(180deg) scale(1.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            color: var(--primary-color);
        }

        /* --- Canvas Wrapper --- */
        .canvas-container {
            background: rgba(255,255,255,0.6);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 220px;
            position: relative;
            margin: 0 auto;
            width: 100%;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.03);
        }

        /* --- Puzzle Specific --- */
        #puzzle-wrapper {
            position: relative;
            width: 340px;
            height: 180px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        canvas.puzzle-main { display: block; }
        canvas.puzzle-piece {
            position: absolute;
            top: 0; left: 0; z-index: 2;
            pointer-events: none;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.6)); /* Deep shadow for 3D effect */
        }

        .slider-container {
            width: 340px;
            margin: 28px auto 0;
            padding: 0 2px;
        }

        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 5px;
            outline: none;
            transition: background 0.2s;
            position: relative;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 0 0 4px var(--primary-color);
            transition: transform 0.2s;
        }
        .slider::-webkit-slider-thumb:hover { transform: scale(1.1); }

        /* --- Image Grid --- */
        .image-instruction {
            background: linear-gradient(to right, #4f46e5, #818cf8);
            color: white;
            padding: 16px 20px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 0;
            text-align: left;
            position: relative;
            overflow: hidden;
        }
        .image-instruction strong { display: block; font-size: 20px; margin-top: 2px; }
        .image-instruction span { font-size: 13px; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            width: 100%;
            max-width: 360px;
            margin: 0 auto;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
            border: 2px solid #818cf8;
            border-top: none;
        }
        .grid-item {
            height: 100px;
            background: #f3f4f6;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }
        .grid-item canvas {
            width: 100%; height: 100%;
            object-fit: cover;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .grid-item:hover canvas { transform: scale(1.1); }
        
        /* Stunning Selection Checkmark */
        .grid-item.selected .selection-overlay {
            position: absolute; inset: 0;
            background: rgba(79, 70, 229, 0.3);
            z-index: 5;
            box-shadow: inset 0 0 0 4px #4f46e5;
            animation: pulse 0.3s;
        }
        .grid-item.selected::after {
            content: '✓';
            position: absolute; top: 6px; right: 6px;
            background: #4f46e5;
            color: white;
            width: 24px; height: 24px;
            border-radius: 50%;
            font-size: 14px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            z-index: 6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            animation: popCheck 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popCheck { 0% { transform: scale(0); } 100% { transform: scale(1); } }

        /* --- Audio --- */
        .audio-wrapper {
            display: flex; flex-direction: column; align-items: center; gap: 24px; padding: 30px;
            background: linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.5) 100%);
        }

        .audio-viz {
            height: 80px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .audio-bar {
            width: 12px; height: 12px;
            background: #d1d5db;
            border-radius: 10px;
            transition: height 0.1s ease;
        }
        .audio-viz.playing .audio-bar {
            background: linear-gradient(to top, #4f46e5, #818cf8);
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.4);
            animation: bounce 0.5s infinite ease-in-out;
        }
        .audio-viz.playing .audio-bar:nth-child(1) { animation-delay: 0.1s; }
        .audio-viz.playing .audio-bar:nth-child(2) { animation-delay: 0.3s; }
        .audio-viz.playing .audio-bar:nth-child(3) { animation-delay: 0.2s; }
        .audio-viz.playing .audio-bar:nth-child(4) { animation-delay: 0.4s; }
        .audio-viz.playing .audio-bar:nth-child(5) { animation-delay: 0.1s; }
        @keyframes bounce { 0%, 100% { height: 12px; } 50% { height: 70px; } }

        /* --- Result --- */
        .token-box {
            background: #f0fdf4;
            color: #15803d;
            padding: 24px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 26px;
            letter-spacing: 4px;
            margin: 24px 0;
            border: 2px dashed #86efac;
            text-align: center;
            font-weight: 700;
            position: relative;
            overflow: hidden;
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .success-animation {
            width: 90px; height: 90px;
            background: #10b981;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 24px;
            animation: elasticScale 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4);
        }
        @keyframes elasticScale { 0% { transform: scale(0); } 70% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        .success-animation svg { fill: white; width: 50px; height: 50px; }

        /* Footer */
        .footer {
            padding: 24px 32px;
            background: rgba(255,255,255,0.4);
            border-top: 1px solid rgba(255,255,255,0.5);
            display: flex; justify-content: space-between;
            font-size: 13px; color: var(--text-secondary);
            font-weight: 500;
        }

        /* Confetti Canvas */
        #confetti-canvas {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-muted { color: var(--text-secondary); font-size: 14px; line-height: 1.6; }
        
        /* SVG Gradient definition helper */
        .svg-defs { position: absolute; width: 0; height: 0; }
    </style>
</head>
<body>

<div class="bg-orb orb-1"></div>
<div class="bg-orb orb-2"></div>
<div class="bg-orb orb-3"></div>

<svg class="svg-defs">
    <defs>
        <linearGradient id="shield-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#4f46e5;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
        </linearGradient>
    </defs>
</svg>

<div class="captcha-container">
    <canvas id="confetti-canvas"></canvas>

    <div class="header">
        <h1>
            <svg class="shield-icon" viewBox="0 0 24 24">
                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
            </svg>
            Secure Verify
        </h1>
        <button id="global-back" class="back-link hidden">Back to Menu</button>
    </div>

    <div class="content">
        
        <div id="view-menu" class="view-section active">
            <p class="text-muted text-center" style="margin-bottom: 8px;">For security, please complete a challenge.</p>
            <div class="menu-grid">
                <div class="menu-card" onclick="App.loadModule('text')">
                    <svg viewBox="0 0 24 24"><path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V8h14v12z"/></svg>
                    <span>Text Challenge</span>
                </div>
                <div class="menu-card" onclick="App.loadModule('puzzle')">
                    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 9h-2V7h2v2h2v2h-2v2zm4 0h-2v2h2v-2z"/></svg>
                    <span>Puzzle Fit</span>
                </div>
                <div class="menu-card" onclick="App.loadModule('image')">
                    <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                    <span>Object Identify</span>
                </div>
                <div class="menu-card" onclick="App.loadModule('audio')">
                    <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                    <span>Audio Verify</span>
                </div>
            </div>
        </div>

        <div id="view-module" class="view-section">
            <div class="module-header">
                <span id="module-title" class="module-title">Verification</span>
                <button class="refresh-btn" title="New Challenge" onclick="App.resetCurrentModule()">
                    <svg style="width:20px;height:20px;fill:var(--text-secondary)" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                </button>
            </div>

            <div id="module-content"></div>
            <div id="feedback-msg" class="text-center" style="margin-top: 16px; height: 20px; font-weight: 600; color: var(--error-color);"></div>
        </div>

        <div id="view-success" class="view-section text-center" style="justify-content: center;">
            <div class="success-animation">
                <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
            </div>
            <h2 style="margin-bottom: 8px; color: var(--text-primary); font-size: 24px;">Humanity Confirmed</h2>
            <p class="text-muted">You have successfully verified your identity.</p>
            <div id="token-display" class="token-box"></div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" onclick="App.returnToMenu()">Return to Menu</button>
        </div>

    </div>

    <div class="footer">
        <span>Protected by <strong style="color:var(--primary-color)">Vedant Kolhe</strong></span>
        <span style="cursor: pointer; opacity: 0.7">Privacy · Terms</span>
    </div>
</div>

<script>
/* =========================================
   PARTICLE PHYSICS ENGINE (Confetti)
   ========================================= */
const Particles = {
    canvas: null,
    ctx: null,
    particles: [],
    init: () => {
        Particles.canvas = document.getElementById('confetti-canvas');
        Particles.ctx = Particles.canvas.getContext('2d');
        Particles.resize();
        window.addEventListener('resize', Particles.resize);
    },
    resize: () => {
        Particles.canvas.width = Particles.canvas.parentElement.offsetWidth;
        Particles.canvas.height = Particles.canvas.parentElement.offsetHeight;
    },
    burst: () => {
        const colors = ['#4f46e5', '#ec4899', '#10b981', '#f59e0b', '#3b82f6'];
        for (let i = 0; i < 100; i++) {
            Particles.particles.push({
                x: Particles.canvas.width / 2,
                y: Particles.canvas.height / 2 + 50,
                vx: (Math.random() - 0.5) * 20,
                vy: (Math.random() - 1) * 20 - 5,
                color: colors[Math.floor(Math.random() * colors.length)],
                size: Math.random() * 8 + 4,
                life: 1,
                decay: 0.01 + Math.random() * 0.02
            });
        }
        Particles.animate();
    },
    animate: () => {
        if (Particles.particles.length === 0) return;
        const ctx = Particles.ctx;
        ctx.clearRect(0, 0, Particles.canvas.width, Particles.canvas.height);
        
        for (let i = 0; i < Particles.particles.length; i++) {
            let p = Particles.particles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.5; // Gravity
            p.life -= p.decay;
            p.size *= 0.96;

            ctx.globalAlpha = p.life;
            ctx.fillStyle = p.color;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fill();

            if (p.life <= 0) {
                Particles.particles.splice(i, 1);
                i--;
            }
        }
        requestAnimationFrame(Particles.animate);
    }
};

/* =========================================
   GRAPHICS ENGINE (Vector-style Art)
   ========================================= */
const Graphics = {
    drawTrafficLight: (ctx, x, y) => {
        // Pole
        ctx.fillStyle = '#1f2937';
        ctx.fillRect(x+12, y+10, 26, 70);
        // Visors
        ctx.fillStyle = '#374151';
        ctx.beginPath(); ctx.arc(x+25, y+24, 9, 0, Math.PI, true); ctx.fill();
        ctx.beginPath(); ctx.arc(x+25, y+44, 9, 0, Math.PI, true); ctx.fill();
        ctx.beginPath(); ctx.arc(x+25, y+64, 9, 0, Math.PI, true); ctx.fill();
        // Lights with Glow
        ctx.shadowBlur = 10;
        ctx.shadowColor = '#ef4444'; ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(x+25, y+24, 6, 0, Math.PI*2); ctx.fill();
        ctx.shadowColor = '#f59e0b'; ctx.fillStyle = '#f59e0b'; ctx.beginPath(); ctx.arc(x+25, y+44, 6, 0, Math.PI*2); ctx.fill();
        ctx.shadowColor = '#10b981'; ctx.fillStyle = '#10b981'; ctx.beginPath(); ctx.arc(x+25, y+64, 6, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
    },
    drawCar: (ctx, x, y, color) => {
        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,0.1)';
        ctx.beginPath(); ctx.ellipse(x+35, y+65, 40, 5, 0, 0, Math.PI*2); ctx.fill();
        // Body
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.moveTo(x+10, y+40); ctx.lineTo(x+60, y+40);
        ctx.lineTo(x+70, y+55); ctx.lineTo(x+70, y+65);
        ctx.lineTo(x+0, y+65); ctx.lineTo(x+0, y+55);
        ctx.fill();
        // Roof
        ctx.fillStyle = '#e5e7eb';
        ctx.beginPath(); ctx.arc(x+35, y+40, 18, Math.PI, 0); ctx.fill();
        // Windows
        ctx.fillStyle = '#9ca3af';
        ctx.beginPath(); ctx.arc(x+35, y+40, 14, Math.PI, 0); ctx.fill();
        // Wheels
        ctx.fillStyle = '#1f2937';
        ctx.beginPath(); ctx.arc(x+15, y+65, 8, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(x+55, y+65, 8, 0, Math.PI*2); ctx.fill();
        // Rims
        ctx.fillStyle = '#d1d5db';
        ctx.beginPath(); ctx.arc(x+15, y+65, 3, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(x+55, y+65, 3, 0, Math.PI*2); ctx.fill();
    },
    drawTree: (ctx, x, y) => {
        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,0.1)';
        ctx.beginPath(); ctx.ellipse(x+35, y+75, 15, 4, 0, 0, Math.PI*2); ctx.fill();
        // Trunk
        const trunkGrad = ctx.createLinearGradient(x+30, y+50, x+40, y+50);
        trunkGrad.addColorStop(0, '#78350f'); trunkGrad.addColorStop(1, '#92400e');
        ctx.fillStyle = trunkGrad;
        ctx.fillRect(x+30, y+50, 10, 25);
        // Leaves (3 layers)
        ctx.fillStyle = '#15803d';
        ctx.beginPath(); ctx.moveTo(x+35, y+10); ctx.lineTo(x+60, y+50); ctx.lineTo(x+10, y+50); ctx.fill();
        ctx.fillStyle = '#16a34a';
        ctx.beginPath(); ctx.moveTo(x+35, y+10); ctx.lineTo(x+55, y+40); ctx.lineTo(x+15, y+40); ctx.fill();
        ctx.fillStyle = '#22c55e';
        ctx.beginPath(); ctx.moveTo(x+35, y+10); ctx.lineTo(x+50, y+30); ctx.lineTo(x+20, y+30); ctx.fill();
    },
    drawHydrant: (ctx, x, y) => {
        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,0.1)';
        ctx.beginPath(); ctx.ellipse(x+28, y+70, 15, 4, 0, 0, Math.PI*2); ctx.fill();
        // Body gradient
        const grad = ctx.createLinearGradient(x, y, x+40, y);
        grad.addColorStop(0, '#991b1b'); grad.addColorStop(0.5, '#ef4444'); grad.addColorStop(1, '#991b1b');
        ctx.fillStyle = grad;
        // Base shape
        ctx.fillRect(x+20, y+30, 16, 40);
        ctx.fillRect(x+15, y+30, 26, 6); // Top ring
        ctx.fillRect(x+15, y+65, 26, 5); // Bottom ring
        // Nozzles
        ctx.fillStyle = '#d1d5db';
        ctx.beginPath(); ctx.arc(x+14, y+45, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(x+42, y+45, 4, 0, Math.PI*2); ctx.fill();
    }
};

/* MAIN APP CONTROLLER */
const App = {
    animationFrameId: null,
    state: { currentModule: null },

    init: () => {
        document.getElementById('global-back').addEventListener('click', App.returnToMenu);
        Particles.init();
    },

    stopAnimations: () => {
        if (App.animationFrameId) cancelAnimationFrame(App.animationFrameId);
        if (window.speechSynthesis) window.speechSynthesis.cancel();
    },

    loadModule: (type) => {
        App.stopAnimations();
        App.state.currentModule = type;
        document.getElementById('feedback-msg').innerText = '';

        const titles = {
            'text': 'Type the moving characters',
            'puzzle': 'Slide to complete the puzzle',
            'image': 'Select matching objects',
            'audio': 'Type the numbers you hear'
        };
        document.getElementById('module-title').innerText = titles[type];

        App.switchView('view-module');
        document.getElementById('global-back').classList.remove('hidden');

        const container = document.getElementById('module-content');
        container.innerHTML = '';
        
        setTimeout(() => {
            if(type === 'text') Modules.Text.init(container);
            if(type === 'puzzle') Modules.Puzzle.init(container);
            if(type === 'image') Modules.Image.init(container);
            if(type === 'audio') Modules.Audio.init(container);
        }, 50);
    },

    verify: (success) => {
        const feedback = document.getElementById('feedback-msg');
        feedback.innerText = 'Verifying...';
        feedback.style.color = '#6b7280';

        setTimeout(() => {
            if (success) {
                const token = 'TOK-' + Math.random().toString(36).substring(2, 9).toUpperCase();
                document.getElementById('token-display').innerText = token;
                App.switchView('view-success');
                App.stopAnimations();
                document.getElementById('global-back').classList.add('hidden');
                Particles.burst(); // EXPLOSION!
            } else {
                feedback.innerText = 'Incorrect. Try again.';
                feedback.style.color = '#ef4444';
                // Shake animation for failure
                const container = document.querySelector('.captcha-container');
                container.animate([
                    { transform: 'translateX(0)' },
                    { transform: 'translateX(-10px)' },
                    { transform: 'translateX(10px)' },
                    { transform: 'translateX(0)' }
                ], { duration: 300 });

                if (App.state.currentModule === 'text') Modules.Text.code = Modules.Text.generateCode(); 
            }
        }, 800);
    },

    resetCurrentModule: () => App.loadModule(App.state.currentModule),
    returnToMenu: () => { App.stopAnimations(); App.switchView('view-menu'); document.getElementById('global-back').classList.add('hidden'); },
    switchView: (id) => {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
};

/* MODULES*/
const Modules = {
    // --- 1. Text ---
    Text: {
        code: '', ctx: null, width: 340, height: 140, startTime: 0,
        particles: [],
        init: (container) => {
            container.innerHTML = `
                <div class="canvas-container">
                    <canvas id="text-canvas" width="340" height="140"></canvas>
                </div>
                <div class="control-row">
                    <input type="text" id="text-input" class="input-field" placeholder="Enter characters" autocomplete="off" maxlength="6">
                    <button class="btn btn-primary" onclick="Modules.Text.check()">Verify</button>
                </div>
            `;
            const canvas = document.getElementById('text-canvas');
            Modules.Text.ctx = canvas.getContext('2d');
            Modules.Text.code = Modules.Text.generateCode();
            Modules.Text.startTime = Date.now();
            Modules.Text.initParticles();
            Modules.Text.loop();
        },
        generateCode: () => {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let res = ''; for(let i=0; i<6; i++) res += chars.charAt(Math.floor(Math.random() * chars.length));
            return res;
        },
        initParticles: () => {
            Modules.Text.particles = [];
            for(let i=0; i<30; i++) {
                Modules.Text.particles.push({
                    x: Math.random() * 340, y: Math.random() * 140,
                    vx: (Math.random()-0.5)*0.5, vy: (Math.random()-0.5)*0.5,
                    size: Math.random() * 2
                });
            }
        },
        loop: () => {
            if(App.state.currentModule !== 'text') return;
            const ctx = Modules.Text.ctx;
            const time = (Date.now() - Modules.Text.startTime) / 1000;
            const w = 340, h = 140;

            ctx.clearRect(0, 0, w, h);

            // Floating Particles
            ctx.fillStyle = 'rgba(79, 70, 229, 0.2)';
            Modules.Text.particles.forEach(p => {
                p.x += p.vx; p.y += p.vy;
                if(p.x<0) p.x=w; if(p.x>w) p.x=0; if(p.y<0) p.y=h; if(p.y>h) p.y=0;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
            });

            // Interference Lines
            ctx.lineWidth = 1;
            for(let i=0; i<5; i++) {
                const y = (i * 25 + time * 30) % h;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.bezierCurveTo(w/3, y-20, 2*w/3, y+20, w, y);
                ctx.strokeStyle = `rgba(16, 185, 129, ${0.2 + Math.sin(time+i)*0.1})`;
                ctx.stroke();
            }

            // Wavy Text
            ctx.font = 'bold 42px monospace';
            ctx.textBaseline = 'middle';
            
            for (let i = 0; i < Modules.Text.code.length; i++) {
                const char = Modules.Text.code[i];
                const x = 50 + (i * 45);
                const yOffset = Math.sin(time * 3 + i) * 12; 
                const angle = Math.sin(time * 2 + i) * 0.2;
                const scale = 1 + Math.sin(time * 4 + i) * 0.1;

                ctx.save();
                ctx.translate(x, h/2 + yOffset);
                ctx.rotate(angle);
                ctx.scale(scale, scale);
                // Gradient Text
                const grad = ctx.createLinearGradient(0, -20, 0, 20);
                grad.addColorStop(0, '#111827'); grad.addColorStop(1, '#4f46e5');
                ctx.fillStyle = grad;
                ctx.fillText(char, 0, 0);
                ctx.restore();
            }
            App.animationFrameId = requestAnimationFrame(Modules.Text.loop);
        },
        check: () => {
            const input = document.getElementById('text-input').value.toUpperCase();
            App.verify(input === Modules.Text.code);
        }
    },

    // --- 2. Puzzle ---
    Puzzle: {
        targetX: 0, yPos: 0,
        init: (container) => {
            container.innerHTML = `
                <div id="puzzle-wrapper">
                    <canvas id="puz-main" class="puzzle-main" width="340" height="180"></canvas>
                    <canvas id="puz-piece" class="puzzle-piece" width="340" height="180"></canvas>
                </div>
                <div class="slider-container">
                    <input type="range" min="0" max="290" value="0" class="slider" id="puz-slider">
                </div>
            `;
            
            Modules.Puzzle.targetX = Math.floor(120 + Math.random() * 160); 
            Modules.Puzzle.yPos = Math.floor(40 + Math.random() * 100);
            Modules.Puzzle.draw();

            const slider = document.getElementById('puz-slider');
            const piece = document.getElementById('puz-piece');
            slider.addEventListener('input', (e) => piece.style.left = e.target.value + 'px');
            slider.addEventListener('change', () => {
                const diff = Math.abs(parseInt(slider.value) - Modules.Puzzle.targetX);
                App.verify(diff < 6);
            });
        },
        draw: () => {
            const main = document.getElementById('puz-main').getContext('2d');
            const piece = document.getElementById('puz-piece').getContext('2d');
            const w = 340, h = 180;
            const px = Modules.Puzzle.targetX, py = Modules.Puzzle.yPos;

            // Artistic Background
            const hue = Math.floor(Math.random() * 360);
            const grad = main.createLinearGradient(0, 0, w, h);
            grad.addColorStop(0, `hsl(${hue}, 80%, 90%)`);
            grad.addColorStop(1, `hsl(${hue + 40}, 80%, 80%)`);
            main.fillStyle = grad;
            main.fillRect(0,0,w,h);

            // Random Geometric Art
            for(let i=0; i<15; i++) {
                main.fillStyle = `hsla(${Math.random()*360}, 60%, 60%, ${0.1 + Math.random()*0.3})`;
                main.beginPath();
                if(i%2===0) main.arc(Math.random()*w, Math.random()*h, 20+Math.random()*40, 0, Math.PI*2);
                else main.rect(Math.random()*w, Math.random()*h, 50, 50);
                main.fill();
            }

            // Target Hole (Inner Shadow)
            main.save();
            main.beginPath();
            main.rect(px, py, 50, 50);
            main.clip();
            main.fillStyle = 'rgba(0,0,0,0.3)'; main.fillRect(0,0,w,h); // Darken
            main.strokeStyle = 'rgba(0,0,0,0.4)'; main.lineWidth = 4; main.strokeRect(px,py,50,50);
            main.restore();

            // The Piece
            piece.clearRect(0,0,w,h);
            piece.save();
            piece.beginPath();
            piece.rect(0, py, 50, 50); // Drawn at 0 x-offset
            piece.clip();
            // Re-draw background on piece
            piece.fillStyle = grad; piece.fillRect(0,0,w,h);
            for(let i=0; i<15; i++) { 
                               
            }
            
            piece.fillStyle = `hsl(${hue+10}, 80%, 85%)`;
            piece.fillRect(0,0,w,h);
            // Add texture
            piece.strokeStyle = 'white'; piece.lineWidth = 3; piece.strokeRect(0, py, 50, 50);
            
            // Puzzle knob
            piece.fillStyle = 'white';
            piece.beginPath(); piece.arc(50, py+25, 8, 0, Math.PI*2); piece.fill();
            
            piece.restore();
        }
    },

    // --- 3. Image Grid (Vector) ---
    Image: {
        selected: [], targets: [],
        init: (container) => {
            const categories = ['Traffic Light', 'Car', 'Tree', 'Fire Hydrant'];
            const type = categories[Math.floor(Math.random() * categories.length)];
            Modules.Image.selected = []; Modules.Image.targets = [];

            container.innerHTML = `
                <div class="image-instruction">
                    <span>Select all squares with a</span>
                    <strong>${type}</strong>
                </div>
                <div class="image-grid" id="img-grid"></div>
                <div class="control-row">
                    <button class="btn btn-primary" style="width:100%" onclick="Modules.Image.check()">Verify</button>
                </div>
            `;

            const grid = document.getElementById('img-grid');
            
            for(let i=0; i<9; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-item';
                const c = document.createElement('canvas');
                c.width = 120; c.height = 100;
                const ctx = c.getContext('2d');
                
                // Sky/Ground Background
                const bg = ctx.createLinearGradient(0,0,0,100);
                bg.addColorStop(0, '#e0f2fe'); bg.addColorStop(0.7, '#bae6fd'); bg.addColorStop(0.7, '#d1d5db'); bg.addColorStop(1, '#9ca3af');
                ctx.fillStyle = bg; ctx.fillRect(0,0,120,100);

                const isTarget = Math.random() > 0.6;
                if(isTarget) Modules.Image.targets.push(i);

                let objType = isTarget ? type : categories.filter(x => x !== type)[Math.floor(Math.random()*3)];
                const ox = Math.random() * 20;

                if(objType === 'Traffic Light') Graphics.drawTrafficLight(ctx, 35+ox, 10);
                else if(objType === 'Car') Graphics.drawCar(ctx, 20+ox, 20, ['#ef4444','#3b82f6','#10b981','#6b7280'][Math.floor(Math.random()*4)]);
                else if(objType === 'Tree') Graphics.drawTree(ctx, 35+ox, 10);
                else if(objType === 'Fire Hydrant') Graphics.drawHydrant(ctx, 35+ox, 20);

                cell.appendChild(c);
                cell.appendChild(document.createElement('div')).className = 'selection-overlay hidden';
                cell.onclick = () => {
                    cell.classList.toggle('selected');
                    cell.querySelector('.selection-overlay').classList.toggle('hidden');
                    const idx = Modules.Image.selected.indexOf(i);
                    if(idx > -1) Modules.Image.selected.splice(idx, 1); else Modules.Image.selected.push(i);
                };
                grid.appendChild(cell);
            }
        },
        check: () => {
            const s = Modules.Image.selected.sort().join(',');
            const t = Modules.Image.targets.sort().join(',');
            App.verify(s === t && t.length > 0);
        }
    },

    // --- 4. Audio ---
    Audio: {
        code: '',
        init: (container) => {
            container.innerHTML = `
                <div class="audio-wrapper">
                    <div id="audio-viz" class="audio-viz">
                        <div class="audio-bar"></div><div class="audio-bar"></div>
                        <div class="audio-bar"></div><div class="audio-bar"></div>
                        <div class="audio-bar"></div>
                    </div>
                    <button class="btn" style="background:white; color:var(--primary-color); border:1px solid #d1d5db;" onclick="Modules.Audio.play()">
                        ▶ Play Audio Challenge
                    </button>
                </div>
                <div class="control-row">
                    <input type="text" id="audio-input" class="input-field" placeholder="Type numbers" autocomplete="off">
                    <button class="btn btn-primary" onclick="Modules.Audio.check()">Verify</button>
                </div>
            `;
            Modules.Audio.code = Math.floor(10000 + Math.random() * 90000).toString();
        },
        play: () => {
            if(!window.speechSynthesis) return alert('Audio API not supported');
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance();
            u.text = Modules.Audio.code.split('').join('. '); 
            u.rate = 0.6; 
            const viz = document.getElementById('audio-viz');
            u.onstart = () => viz.classList.add('playing');
            u.onend = () => viz.classList.remove('playing');
            u.onerror = () => viz.classList.remove('playing');
            window.speechSynthesis.speak(u);
        },
        check: () => {
            const val = document.getElementById('audio-input').value.replace(/\D/g,'');
            App.verify(val === Modules.Audio.code);
        }
    }
};

// Start
App.init();
</script>
</body>
</html>